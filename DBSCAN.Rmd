---
title: "Clean and RFM - DBSCAn"
author: "Nguyá»…n Nháº­t Nam, HÃ  Tháº¿ Anh"
output:
  html_document:
    toc: true
    toc_depth: '3'
    df_print: paged
  word_document:
    toc: true
    toc_depth: 3
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
    fig_height: 5
    fig_width: 7
    highlight: tango
header-includes:
- \usepackage{graphicx}
- \usepackage{fontspec}
- \setmainfont{Times New Roman}
---
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
Sys.setlocale("LC_ALL", "English_United States.UTF-8")

```

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(cluster)
library(factoextra)
library(lubridate)
library(scales)
library(psych)
library(readxl)
library(dplyr)
library(ggplot2)
library(plotly)
```


# Tiá»n xá»­ lÃ½ dá»¯ liá»‡u

```{r message=FALSE, warning=FALSE}
# Äá»c dá»¯ liá»‡u
df <- read_excel("Online Retail.xlsx")
head(df)  

```

  InvoiceNo: MÃ£ Ä‘Æ¡n hÃ ng 
  
  StockCode: MÃ£ sáº£n pháº©m 
  
  Description: MÃ´ táº£ sáº£n pháº©m 
  
  Quantity: Sá»‘ lÆ°á»£ng sáº£n pháº©m 
  
  InvoiceDate: NgÃ y hÃ³a Ä‘Æ¡n 
  
  UnitPrice: GiÃ¡ sáº£n pháº©m trÃªn má»—i Ä‘Æ¡n vá»‹ 
  
  CustomerID: MÃ£ khÃ¡ch hÃ ng 
  
  Country: Quá»‘c gia cá»§a khÃ¡ch hÃ ng
  

```{r}
#Kiá»ƒm tra kiá»ƒu dá»¯ liá»‡u
str(df)
```


```{r}
# thá»‘ng kÃª mÃ´ táº£ dá»¯ liá»‡u 
describe(df)

```

```{r}
# Thá»‘ng kÃª data object 
summary(df[, sapply(df, is.character)])
```
```{r}
#kiá»ƒm tra dá»¯ liá»‡u thiáº¿u 
colSums(is.na(df))
```


```{r}
# Kiá»ƒm tra giÃ¡ trá»‹ thiáº¿u cá»§a CustomerID
df_na <- df[is.na(df$CustomerID), ]
print(df_na[sample(nrow(df_na), 10), ], width = Inf)
```

```{r}
# Chuyá»ƒn 'InvoiceNo' vá» kiá»ƒu chuá»—i
df$InvoiceNo <- as.character(df$InvoiceNo)
#Lá»c ra nhá»¯ng dÃ²ng KHÃ”NG cÃ³ InvoiceNo Ä‘Ãºng 6 chá»¯ sá»‘
df[!grepl("^\\d{6}$", df$InvoiceNo), ]

#Kiá»ƒm tra kÃ­ tá»± khÃ¡c trong cá»™t InvoiceNo 
unique(gsub("[0-9]", "", df$InvoiceNo))

# kiá»ƒm tra col 'InvoiceNo' cÃ³ giÃ¡ trá»‹ nÃ o báº¯t Ä‘áº§u báº±ng kÃ­ tá»± 'A' ko
df[grepl("^A", df$InvoiceNo), ]
```
```{r}
# Äáº£m báº£o 'StockCode' lÃ  kiá»ƒu chuá»—i
df$StockCode <- as.character(df$StockCode)
# Lá»c nhá»¯ng dÃ²ng KHÃ”NG pháº£i 5 chá»¯ sá»‘ hoáº·c 5 chá»¯ sá»‘ + chá»¯ cÃ¡i
mask <- !(grepl("^\\d{5}$", df$StockCode) | grepl("^\\d{5}[a-zA-Z]+$", df$StockCode))
# Láº¥y cÃ¡c StockCode sai Ä‘á»‹nh dáº¡ng vÃ  loáº¡i trÃ¹ng
invalid_stockcodes <- unique(df$StockCode[mask])
# Hiá»ƒn thá»‹ káº¿t quáº£
print(invalid_stockcodes)
# Lá»c nhá»¯ng dÃ²ng cÃ³ chá»©a chuá»—i 'DOT'
df_with_DOT <- df[grepl("DOT", df$StockCode), ]
# Hiá»ƒn thá»‹ káº¿t quáº£
print(df_with_DOT)
```

 **Stock Code**

- **Include** ğŸŸ¢ â†’ Giá»¯ láº¡i Ä‘á»ƒ phÃ¢n tÃ­ch hoáº·c clustering.  
- **Exclude** âŒ â†’ Loáº¡i bá» hoÃ n toÃ n, khÃ´ng dÃ¹ng Ä‘á»ƒ phÃ¢n tÃ­ch.  
- **Exclude from clustering** ğŸš« â†’ KhÃ´ng dÃ¹ng Ä‘á»ƒ phÃ¢n nhÃ³m nhÆ°ng cÃ³ thá»ƒ tham kháº£o.  
- **Exclude for now** â³ â†’ Táº¡m loáº¡i bá», cÃ³ thá»ƒ xem xÃ©t láº¡i sau. 

- **StockCode** is meant to follow the pattern `[0-9]{5}` but seems to have legit values for `[0-9]{5}[a-zA-Z]+`.  
&nbsp;&nbsp;&nbsp;&nbsp; **Also contains other values:** 



| Code             | Description                                                                 | Action                      |
|------------------|-----------------------------------------------------------------------------|-----------------------------|
| POST            | Not listed previously, likely a postage-related transaction                | Exclude for now             |
| D               | Looks valid, represents discount values                                    | Exclude from clustering     |
| C2              | Carriage transaction - not sure what this means                           | Exclude from clustering     |
| DOT             | Looks valid, represents postage charges                                   | Exclude from clustering     |
| M or m          | Looks valid, represents manual transactions                               | Exclude from clustering     |
| BANK CHARGES or B | Bank charges                                                           | Exclude from clustering     |
| S               | Samples sent to customer                                                 | Exclude from clustering     |
| AMAZONFEE       | Looks like fees for Amazon shipping or something                         | Exclude for now             |
| DCGS0076        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0003        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| gift_0001_40    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| DCGS0070        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| m               | Looks valid, represents manual transactions                              | Exclude from clustering     |
| gift_0001_50    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| gift_0001_30    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| gift_0001_20    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| DCGS0055        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0072        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0074        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0069        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0057        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGSSBOY        | Possible category or bundle-related code                                 | Exclude for now             |
| DCGSSGIRL       | Possible category or bundle-related code                                 | Exclude for now             |
| gift_0001_10    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| PADS            | Looks like a legit stock code for padding                                | Include                     |
| DCGS0004        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0073        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0071        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0068        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0067        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0066P       | Variant of DCGS, possibly a special category                            | Exclude from clustering     |
| B               | Bank charges                                                             | Exclude from clustering     |
| CRUK            | Unknown, possibly a charity-related code                                | Exclude for now             |


# Xá»­ lÃ½ dá»¯ liá»‡u 

```{r}
# Chuyá»ƒn InvoiceDate thÃ nh kiá»ƒu Date
df$InvoiceDate <- as.Date(df$InvoiceDate)
str(df)
```

```{r}
# 1. GÃ¡n láº¡i df gá»‘c
df_cleaned <- df
# Loáº¡i bá» toÃ n bá»™ dÃ²ng chá»©a báº¥t ká»³ kÃ½ tá»± KHÃ”NG PHáº¢I sá»‘ (0â€“9)
df_cleaned <- df_cleaned[grepl("^[0-9]+$", df_cleaned$InvoiceNo), ]

```

```{r}
# Kiá»ƒm tra cÃ²n chá»¯ cÃ¡i khÃ´ng?
any(grepl("[A-Za-z]", df_cleaned$InvoiceNo))  # Pháº£i tráº£ FALSE

# Kiá»ƒm tra cÃ²n kÃ½ tá»± Ä‘áº·c biá»‡t khÃ´ng?
any(grepl("[^0-9]", df_cleaned$InvoiceNo))    # Pháº£i tráº£ FALSE
```

```{r}

# Táº¡o Ä‘iá»u kiá»‡n giá»¯ láº¡i cÃ¡c StockCode há»£p lá»‡:
mask <- grepl("^\\d{5,6}$", df_cleaned$StockCode) |           # ToÃ n sá»‘, 5-6 chá»¯ sá»‘
        grepl("^\\d{5}[A-Za-z]$", df_cleaned$StockCode) |     # 5 sá»‘ + 1 chá»¯ cÃ¡i
        df_cleaned$StockCode == "APADSS"                      # MÃ£ Ä‘áº·c biá»‡t

# Ãp dá»¥ng lá»c
df_cleaned <- df_cleaned[mask, ]

df_cleaned
```
```{r}
sum(is.na(df$CustomerID))  # Ä‘áº¿m sá»‘ dÃ²ng bá»‹ thiáº¿u
```

```{r}
# XÃ³a cÃ¡c dÃ²ng cÃ³ NA á»Ÿ cá»™t CustomerID
df_cleaned <- df_cleaned[!is.na(df_cleaned$CustomerID), ]

nrow(df) - nrow(df_cleaned)  # sá»‘ dÃ²ng Ä‘Ã£ bá»‹ xÃ³a

colSums(is.na(df_cleaned))
```

```{r}
# thá»‘ng kÃª data sau khi drop na
summary(df_cleaned)

```

**Nháº­n xÃ©t tá»•ng quan vá» dá»¯ liá»‡u df_cleaned:**




```{r}
# kiá»ƒm tra giÃ¡ trá»‹ báº±ng 0 cá»§a col 'UnitPrice'
sum(df_cleaned$UnitPrice == 0)
# chá»‰ láº¥y giÃ¡ trá»‹ khÃ¡c 0 
df_cleaned <- df_cleaned[df_cleaned$UnitPrice > 0, ]
#Kiá»ƒm tra 
summary(df_cleaned)

```

```{r}
#TÃ­nh tá»· lá»‡ pháº§n trÄƒm sá»‘ dÃ²ng cÃ²n láº¡i trong df_cleaned so vá»›i tá»•ng sá»‘ dÃ²ng ban Ä‘áº§u trong df.
sprintf("%.2f%%", nrow(df_cleaned) / nrow(df) * 100)
```


```{r}
##Trá»±c quan hÃ³a
# Sá»‘ dÃ²ng ban Ä‘áº§u vÃ  sau khi lÃ m sáº¡ch
total_rows <- nrow(df)
cleaned_rows <- nrow(df_cleaned)
removed_rows <- total_rows - cleaned_rows
# Táº¡o dataframe Ä‘á»ƒ váº½
summary_df <- data.frame(
  Tráº¡ng_thÃ¡i = c("Giá»¯ láº¡i", "ÄÃ£ loáº¡i"),
  Sá»‘_lÆ°á»£ng = c(cleaned_rows, removed_rows)
)
# Váº½ biá»ƒu Ä‘á»“
barplot(
  summary_df$Sá»‘_lÆ°á»£ng,
  names.arg = summary_df$Tráº¡ng_thÃ¡i,
  col = c("skyblue", "salmon"),
  main = "So sÃ¡nh sá»‘ dÃ²ng trÆ°á»›c vÃ  sau khi lÃ m sáº¡ch",
  ylab = "Sá»‘ dÃ²ng",
  ylim = c(0, max(summary_df$Sá»‘_lÆ°á»£ng) * 1.1)
)
# Hiá»ƒn thá»‹ sá»‘ liá»‡u trÃªn cá»™t
text(
  x = c(1, 2),
  y = summary_df$Sá»‘_lÆ°á»£ng,
  labels = summary_df$Sá»‘_lÆ°á»£ng,
  pos = 3,
  cex = 1.2
)
```

##Analysis RFM 

```{r}
# táº¡o cá»™t tá»•ng chi tiÃªu lÃ m Monetary (tá»•ng chi tiÃªu)
df_cleaned$SalesLineTotal <- df_cleaned$Quantity * df_cleaned$UnitPrice
# Hiá»ƒn thá»‹ káº¿t quáº£
print(df_cleaned, width = Inf)
```


```{r}
aggregated_df <- summarise(
  group_by(df_cleaned, CustomerID),
  MonetaryValue = sum(SalesLineTotal, na.rm = TRUE),
  Frequency = n_distinct(InvoiceNo),
  LastInvoiceDate = max(InvoiceDate)
)
```


```{r}
# TÃ­nh Recency
analysis_date <- as.Date(max(df_cleaned$InvoiceDate))
aggregated_df$Recency <- as.numeric(analysis_date - aggregated_df$LastInvoiceDate)

print(aggregated_df, width = Inf)

```

```{r}
# Thiáº¿t láº­p bá»‘ cá»¥c 1 hÃ ng 3 biá»ƒu Ä‘á»“
par(mfrow = c(1, 3), mar = c(4, 4, 3, 1))  # 1 dÃ²ng, 3 cá»™t

# Biá»ƒu Ä‘á»“ 1: Monetary Value
hist(aggregated_df$MonetaryValue,
     breaks = 10,
     col = "skyblue",
     border = "red",
     main = "Monetary Value Distribution",
     xlab = "Monetary Value",
     ylab = "Count")

# Biá»ƒu Ä‘á»“ 2: Frequency
hist(aggregated_df$Frequency,
     breaks = 10,
     col = "lightgreen",
     border = "red",
     main = "Frequency Distribution",
     xlab = "Frequency",
     ylab = "Count")

# Biá»ƒu Ä‘á»“ 3: Recency
hist(aggregated_df$Recency,
     breaks = 20,
     col = "yellow",
     border = "red",
     main = "Recency Distribution",
     xlab = "Recency",
     ylab = "Count")

# Reset layout vá» máº·c Ä‘á»‹nh (1 biá»ƒu Ä‘á»“/khung)
par(mfrow = c(1, 1))
```
**Nháº­n xÃ©t**

  - **Monetary Value Distribution (GiÃ¡ trá»‹ chi tiÃªu):**
  
      * PhÃ¢n bá»‘ ráº¥t lá»‡ch pháº£i (right-skewed).

      * Pháº§n lá»›n khÃ¡ch hÃ ng cÃ³ tá»•ng chi tiÃªu (Monetary) ráº¥t tháº¥p (Ä‘a sá»‘ < 10,000).

      * Chá»‰ má»™t sá»‘ Ã­t khÃ¡ch chi tiÃªu ráº¥t cao (cÃ³ giÃ¡ trá»‹ tá»›i 250,000+), táº¡o ra outlier ráº¥t máº¡nh.
      
  - **Káº¿t luáº­n:**
    
      * Táº­p khÃ¡ch hÃ ng cÃ³ sá»± khÃ¡c biá»‡t lá»›n vá» giÃ¡ trá»‹ â€“ phÃ¹ há»£p Ä‘á»ƒ phÃ¢n nhÃ³m (clustering).
    
      * NÃªn xem xÃ©t log-transform hoáº·c winsorizing trÆ°á»›c khi dÃ¹ng cho mÃ´ hÃ¬nh.
    
  - **Frequency Distribution (Táº§n suáº¥t mua hÃ ng):**

      * Cá»±c ká»³ lá»‡ch pháº£i: gáº§n nhÆ° táº¥t cáº£ khÃ¡ch chá»‰ mua 1â€“2 láº§n.

      * Ráº¥t Ã­t khÃ¡ch hÃ ng mua tá»« 10 láº§n trá»Ÿ lÃªn (hiáº¿m cÃ³ >50).

      * Má»™t vÃ i giÃ¡ trá»‹ lá»›n (outlier) váº«n tá»“n táº¡i.

  - **Káº¿t luáº­n:**
  
      * Pháº§n lá»›n khÃ¡ch hÃ ng khÃ´ng trung thÃ nh â†’ chá»‰ mua 1 láº§n.

      * Ráº¥t cáº§n phÃ¡t triá»ƒn nhÃ³m khÃ¡ch â€œfrequent buyersâ€ (náº¿u muá»‘n tÄƒng CLV).

      * CÃ³ thá»ƒ táº¡o chÃ­nh sÃ¡ch Æ°u Ä‘Ã£i táº§n suáº¥t cho nhÃ³m tiá»m nÄƒng.

  - **Recency Distribution (Khoáº£ng thá»i gian ká»ƒ tá»« láº§n mua gáº§n nháº¥t):**

      * PhÃ¢n bá»‘ cÅ©ng lá»‡ch pháº£i nhÆ°ng nháº¹ hÆ¡n.

      * Nhiá»u khÃ¡ch hÃ ng má»›i mua gáº§n Ä‘Ã¢y (Recency tháº¥p) â†’ táº­p trung á»Ÿ khoáº£ng 0â€“50 ngÃ y.

      * CÃ ng xa (Recency cao), sá»‘ lÆ°á»£ng khÃ¡ch giáº£m dáº§n â†’ biá»ƒu hiá»‡n tá»‘t.

  - **Káº¿t luáº­n:**
  
      * CÃ³ nhiá»u khÃ¡ch hÃ ng má»›i hoáº¡t Ä‘á»™ng gáº§n Ä‘Ã¢y.

      * CÆ¡ há»™i ráº¥t tá»‘t Ä‘á»ƒ cháº¡y láº¡i remarketing hoáº·c tÃ¡i kÃ­ch hoáº¡t khÃ¡ch cÅ©.

      * Táº­p khÃ¡ch cÅ© (Recency > 250) cÃ³ thá»ƒ lÃ  khÃ¡ch rá»i bá».
      
**kiá»ƒm tra outlier**

```{r}
data_outliers <- aggregated_df
```

```{r}
# Äáº·t layout: 1 hÃ ng, 3 biá»ƒu Ä‘á»“
par(mfrow = c(1, 3), mar = c(4, 4, 3, 1))

# Boxplot 1: MonetaryValue
boxplot(aggregated_df$MonetaryValue,
        col = "skyblue",
        main = "Monetary Value Boxplot",
        xlab = "Monetary Value")

# Boxplot 2: Frequency
boxplot(aggregated_df$Frequency,
        col = "lightgreen",
        main = "Frequency Boxplot",
        xlab = "Frequency")

# Boxplot 3: Recency
boxplot(aggregated_df$Recency,
        col = "salmon",
        main = "Recency Boxplot",
        xlab = "Recency")

# Reset láº¡i layout vá» máº·c Ä‘á»‹nh (1 biá»ƒu Ä‘á»“)
par(mfrow = c(1, 1))
```


```{r}
# TÃ­nh Q1, Q3 vÃ  IQR cho MonetaryValue
M_Q1 <- quantile(aggregated_df$MonetaryValue, 0.25)
M_Q3 <- quantile(aggregated_df$MonetaryValue, 0.75)
M_IQR <- M_Q3 - M_Q1

# Lá»c cÃ¡c dÃ²ng lÃ  outlier
monetary_outliers_df <- aggregated_df[
  aggregated_df$MonetaryValue < (M_Q1 - 1.5 * M_IQR) |
  aggregated_df$MonetaryValue > (M_Q3 + 1.5 * M_IQR),
]

# Xem mÃ´ táº£ dá»¯ liá»‡u outlier
summary(monetary_outliers_df)

```

```{r}
# TÃ­nh Q1, Q3 vÃ  IQR cho Frequency
F_Q1 <- quantile(aggregated_df$Frequency, 0.25)
F_Q3 <- quantile(aggregated_df$Frequency, 0.75)
F_IQR <- F_Q3 - F_Q1

# Lá»c cÃ¡c dÃ²ng lÃ  outlier theo Frequency
frequency_outliers_df <- aggregated_df[
  aggregated_df$Frequency < (F_Q1 - 1.5 * F_IQR) |
  aggregated_df$Frequency > (F_Q3 + 1.5 * F_IQR),
]

# Thá»‘ng kÃª dá»¯ liá»‡u outlier
summary(frequency_outliers_df)

```

```{r}
# Loáº¡i bá» outlier báº±ng cÃ¡ch giá»¯ láº¡i cÃ¡c dÃ²ng KHÃ”NG náº±m trong monetary vÃ  frequency outliers

# Láº¥y chá»‰ sá»‘ hÃ ng (index) cáº§n loáº¡i bá»
outlier_indices <- union(
  which(aggregated_df$MonetaryValue < (M_Q1 - 1.5 * M_IQR) | aggregated_df$MonetaryValue > (M_Q3 + 1.5 * M_IQR)),
  which(aggregated_df$Frequency < (F_Q1 - 1.5 * F_IQR) | aggregated_df$Frequency > (F_Q3 + 1.5 * F_IQR))
)

# Giá»¯ láº¡i cÃ¡c dÃ²ng khÃ´ng náº±m trong chá»‰ sá»‘ outlier
non_outliers_df <- aggregated_df[-outlier_indices, ]

# Kiá»ƒm tra láº¡i
summary(non_outliers_df)

```


```{r}
# Trá»±c quan sau khi loáº¡i bá» 
# Chia khung hÃ¬nh ra 1 dÃ²ng 3 biá»ƒu Ä‘á»“
par(mfrow = c(1, 3), mar = c(4, 4, 3, 1))

# Boxplot 1: Monetary Value
boxplot(non_outliers_df$MonetaryValue,
        col = "skyblue",
        main = "Monetary Value Boxplot",
        xlab = "Monetary Value")

# Boxplot 2: Frequency
boxplot(non_outliers_df$Frequency,
        col = "lightgreen",
        main = "Frequency Boxplot",
        xlab = "Frequency")

# Boxplot 3: Recency
boxplot(non_outliers_df$Recency,
        col = "salmon",
        main = "Recency Boxplot",
        xlab = "Recency")

# Reset láº¡i layout vá» máº·c Ä‘á»‹nh
par(mfrow = c(1, 1))
```


```{r}
# Váº½ scatter plot 3D
plot_ly(non_outliers_df,
        x = ~MonetaryValue,
        y = ~Frequency,
        z = ~Recency,
        type = 'scatter3d',
        mode = 'markers',
        marker = list(size = 2, color = 'blue')) %>%
  layout(
    title = list(text = "3D Scatter Plot of Customer Data"),
    scene = list(
      xaxis = list(title = "Monetary"),
      yaxis = list(title = "Frequency"),
      zaxis = list(title = "Recency")
    )
  )


```
```{r}
# Chuáº©n hÃ³a cÃ¡c cá»™t MonetaryValue, Frequency, Recency
scaled_data <- scale(non_outliers_df[, c("MonetaryValue", "Frequency", "Recency")])
```

```{r}
# Chuyá»ƒn matrix chuáº©n hÃ³a vá» data.frame
scaled_data_df <- as.data.frame(scaled_data)

# Äáº·t láº¡i tÃªn cá»™t
colnames(scaled_data_df) <- c("MonetaryValue", "Frequency", "Recency")

# GÃ¡n láº¡i rownames náº¿u cáº§n giá»¯ index
rownames(scaled_data_df) <- rownames(non_outliers_df)
# Xem káº¿t quáº£
head(scaled_data_df)
```

```{r}
plot_ly(scaled_data_df,
        x = ~MonetaryValue,
        y = ~Frequency,
        z = ~Recency,
        type = "scatter3d",
        mode = "markers",
        marker = list(size = 2, color = 'blue')) %>%
  layout(title = "3D Scatter Plot of Scaled Customer Data")
```

# PhÃ¢n cá»¥m dá»¯ liá»‡u sá»­ dá»¥ng DBSCAN

**(Density-Based Spatial Clustering of Applications with Noise)** lÃ  má»™t thuáº­t toÃ¡n phÃ¢n cá»¥m dá»±a trÃªn máº­t Ä‘á»™. ÄÆ°á»£c giá»›i thiá»‡u bá»Ÿi Martin Ester, Hans-Peter Kriegel, JÃ¶rg Sander, vÃ  Xiaowei Xu vÃ o nÄƒm 1996, DBSCAN Ä‘Ã£ trá»Ÿ thÃ nh má»™t trong nhá»¯ng thuáº­t toÃ¡n phÃ¢n cá»¥m phá»• biáº¿n nháº¥t trong há»c mÃ¡y khÃ´ng giÃ¡m sÃ¡t.

KhÃ¡c vá»›i K-Means dá»±a trÃªn khoáº£ng cÃ¡ch Euclidean vÃ  yÃªu cáº§u xÃ¡c Ä‘á»‹nh trÆ°á»›c sá»‘ cá»¥m, DBSCAN nhÃ³m cÃ¡c Ä‘iá»ƒm dá»±a trÃªn máº­t Ä‘á»™ cá»§a chÃºng trong khÃ´ng gian dá»¯ liá»‡u. Äiá»u nÃ y giÃºp DBSCAN cÃ³ nhiá»u Æ°u Ä‘iá»ƒm:

- KhÃ´ng cáº§n biáº¿t trÆ°á»›c sá»‘ lÆ°á»£ng cá»¥m

- PhÃ¡t hiá»‡n Ä‘Æ°á»£c cá»¥m cÃ³ hÃ¬nh dáº¡ng tÃ¹y Ã½, khÃ´ng chá»‰ cá»¥m hÃ¬nh cáº§u

- CÃ³ kháº£ nÄƒng phÃ¡t hiá»‡n vÃ  loáº¡i bá» nhiá»…u (outliers)

- Hiá»‡u quáº£ vá»›i bá»™ dá»¯ liá»‡u lá»›n

## XÃ¡c Ä‘á»‹nh tham sá»‘ cho DBSCAN

Bá»™ dá»¯ liá»‡u Online Retail qua bÆ°á»›c tiá»n xá»­ lÃ½ Ä‘Æ°á»£c lÆ°u vÃ o scaled_data, trÆ°á»›c khi tiáº¿n hÃ nh phÃ¢n cá»¥m ta cáº§n xÃ¡c Ä‘á»‹nh cÃ¡c tham sá»‘ cho DBSCAN

### XÃ¡c Ä‘á»‹nh MinPts

MinPts xÃ¡c Ä‘á»‹nh sá»‘ lÆ°á»£ng Ä‘iá»ƒm tá»‘i thiá»ƒu cáº§n cÃ³ trong vÃ¹ng lÃ¢n cáº­n Ä‘á»ƒ má»™t Ä‘iá»ƒm Ä‘Æ°á»£c coi lÃ  Ä‘iá»ƒm lÃµi.thÃ´ng thÆ°á»ng chÃºng ta chá»n MinPts â‰¥ D + 1, trong Ä‘Ã³ D lÃ  sá»‘ chiá»u cá»§a dá»¯ liá»‡u, trong bá»™ dá»¯ liá»‡u nÃ y ta dÃ¹ng ba chá»‰ sá»‘ lÃ  RFM Ä‘á»ƒ phÃ¢n cá»¥m nÃªn MinPts = 4 lÃ  lá»±a chá»n há»£p lÃ½.

### XÃ¡c Ä‘á»‹nh Epsilon (Îµ)

Epsilon xÃ¡c Ä‘á»‹nh bÃ¡n kÃ­nh vÃ¹ng lÃ¢n cáº­n. ÄÃ¢y lÃ  tham sá»‘ khÃ³ xÃ¡c Ä‘á»‹nh nháº¥t vÃ  cÃ³ áº£nh hÆ°á»Ÿng lá»›n Ä‘áº¿n káº¿t quáº£ phÃ¢n cá»¥m.

Äá»ƒ xÃ¡c Ä‘á»‹nh Epsilon ta dÃ¹ng phÆ°Æ¡ng phÃ¡p k-distance graph, cÃ¡ch phá»• biáº¿n nháº¥t Ä‘á»ƒ xÃ¡c Ä‘á»‹nh Îµ phÃ¹ há»£p, cÃ¡c bÆ°á»›c xÃ¡c Ä‘á»‹nh báº±ng phÆ°Æ¡ng phÃ¡p k-distance graph bao gá»“m:

1. Vá»›i má»—i Ä‘iá»ƒm, tÃ­nh khoáº£ng cÃ¡ch Ä‘áº¿n Ä‘iá»ƒm thá»© k gáº§n nháº¥t (k = MinPts - 1)

2. Sáº¯p xáº¿p cÃ¡c khoáº£ng cÃ¡ch nÃ y theo thá»© tá»± tÄƒng dáº§n

3. Váº½ Ä‘á»“ thá»‹ k-distance

4. TÃ¬m "Ä‘iá»ƒm gáº©y" (elbow point) - Ä‘iá»ƒm mÃ  táº¡i Ä‘Ã³ Ä‘Æ°á»ng cong cÃ³ sá»± thay Ä‘á»•i Ä‘Ã¡ng ká»ƒ

5. Chá»n Îµ táº¡i Ä‘iá»ƒm gáº©y nÃ y

```{r message=FALSE, warning=FALSE, fig.cap="Äá»“ thá»‹ xÃ¡c Ä‘á»‹nh Eps xá»­ dá»¥ng phÆ°Æ¡ng phÃ¡p k-distance graph"}
# CÃ i Ä‘áº·t vÃ  náº¡p cÃ¡c gÃ³i cáº§n thiáº¿t
library(dbscan)  # Cho thuáº­t toÃ¡n DBSCAN
library(factoextra)  # Cho trá»±c quan hÃ³a
library(fpc)  # Cho Ä‘Ã¡nh giÃ¡ phÃ¢n cá»¥m
library(ggplot2)  # Cho váº½ biá»ƒu Ä‘á»“
library(cluster)  # Cho hÃ m silhouette


scaled_data_DB <- scale(non_outliers_df[, c("MonetaryValue", "Frequency", "Recency")])

# TÃ­nh khoáº£ng cÃ¡ch k-nearest neighbors
k=3
knn_dists <- kNNdist(scaled_data_DB, k = k)

# Sáº¯p xáº¿p khoáº£ng cÃ¡ch vÃ  váº½ Ä‘á»“ thá»‹
eps_candidates <- sort(knn_dists)
plot(eps_candidates, type = "l", 
     xlab = "Äiá»ƒm dá»¯ liá»‡u (Ä‘Ã£ sáº¯p xáº¿p)",
     ylab = paste("Khoáº£ng cÃ¡ch Ä‘áº¿n Ä‘iá»ƒm thá»©", k, "gáº§n nháº¥t"),
     main = "PhÆ°Æ¡ng phÃ¡p k-distance")

# TÃ¬m vá»‹ trÃ­ cá»§a Ä‘iá»ƒm gáº©y thá»§ cÃ´ng (khoáº£ng 0.5)
eps_value <- 0.4
eps_index <- which.min(abs(eps_candidates - eps_value))

# ÄÃ¡nh dáº¥u Ä‘iá»ƒm gáº©y
points(eps_index, eps_candidates[eps_index], col = "red", pch = 19)
text(eps_index, eps_candidates[eps_index], 
     labels = paste("Îµ â‰ˆ", round(eps_candidates[eps_index], 2)), 
     pos = 4, col = "red")

# Váº½ Ä‘Æ°á»ng tháº³ng táº¡i Ä‘iá»ƒm gáº©y (thá»§ cÃ´ng á»Ÿ má»©c 0.5)
abline(h = eps_value, col = "red", lty = 2)
```


Biá»ƒu Ä‘á»“ cho tháº¥y khoáº£ng cÃ¡ch tÄƒng dáº§n má»™t cÃ¡ch á»•n Ä‘á»‹nh cho Ä‘áº¿n khoáº£ng 3700 Ä‘iá»ƒm, sau Ä‘Ã³ tÄƒng máº¡nh, táº¡o thÃ nh má»™t Ä‘iá»ƒm gáº©y táº¡i khoáº£ng cÃ¡ch 0.4. Äiá»ƒm nÃ y Ä‘Æ°á»£c chá»n lÃ m giÃ¡ trá»‹ epsilon (eps = 0.4) cho thuáº­t toÃ¡n DBSCAN 

## PhÃ¢n cá»¥m, Ä‘Ã¡nh giÃ¡ cháº¥t lÆ°á»£ng phÃ¢n cá»¥m DBSCAN 

Khi Ä‘Ã£ xÃ¡c Ä‘á»‹nh Ä‘Æ°á»£c cÃ¡c tham sá»‘ cho mÃ´ hÃ¬nh ta cÃ³ thá»ƒ dá»… dÃ ng phÃ¢n cá»¥m dá»¯ liá»‡u xá»­ dá»¥ng thÆ° viá»‡n DBSCAN, trong quÃ¡ trÃ¬nh phÃ¢n cá»¥m dá»¯ liá»‡u RFM báº±ng thuáº­t toÃ¡n DBSCAN vá»›i cÃ¡c tham sá»‘ tá»‘i Æ°u Ä‘Æ°á»£c lá»±a chá»n lÃ  eps = 0.4 vÃ  minPts = 4, ta tiáº¿n hÃ nh Ä‘Ã¡nh giÃ¡ cháº¥t lÆ°á»£ng phÃ¢n cá»¥m dá»±a trÃªn hai chá»‰ sá»‘ phá»• biáº¿n: Silhouette Score vÃ  Calinski-Harabasz Index, tá»· lá»‡ nhiá»…u (Noise Ratio) 

### Silhouette Score
```{r}
# Ãp dá»¥ng DBSCAN vá»›i tham sá»‘ phÃ¹ há»£p
db_result <- dbscan(scaled_data_DB, eps = 0.4, MinPts = 4)
non_noise <- which(db_result$cluster > 0)

# Náº¿u sá»‘ lÆ°á»£ng cá»¥m há»£p lá»‡ > 1 thÃ¬ má»›i tÃ­nh Silhouette
if (length(unique(db_result$cluster[non_noise])) > 1) {
  
  # TÃ­nh silhouette
  sil <- silhouette(db_result$cluster[non_noise], dist(scaled_data_DB[non_noise, ]))
  
  # TÃ­nh Ä‘iá»ƒm silhouette trung bÃ¬nh toÃ n bá»™
  avg_sil <- mean(sil[, 3], na.rm = TRUE)
  cat("Äiá»ƒm Silhouette trung bÃ¬nh:", avg_sil, "\n")
  
  # Táº¡o dataframe tá»« silhouette object
  sil_df <- as.data.frame(sil)
  
  # TÃ­nh Silhouette trung bÃ¬nh theo tá»«ng cá»¥m
  avg_sil_by_cluster <- sil_df %>%
    group_by(cluster) %>%
    summarise(avg_sil_width = mean(sil_width))
  
  # Váº½ biá»ƒu Ä‘á»“ cá»™t
  dev.new(width = 10, height = 8)
  ggplot(avg_sil_by_cluster, aes(x = factor(cluster), y = avg_sil_width)) +
    geom_col(fill = "steelblue") +
    labs(title = "Silhouette Score theo tá»«ng cá»¥m",
         x = "Cá»¥m",
         y = "Silhouette Score trong tá»«ng cá»¥m") +
    theme_minimal()
  
} else {
  cat("KhÃ´ng Ä‘á»§ sá»‘ cá»¥m Ä‘á»ƒ tÃ­nh Silhouette Score.\n")
}
```
Äiá»ƒm Silhouette trung bÃ¬nh: ~0.0496 cho tháº¥y cÃ¡c cá»¥m chÆ°a thá»±c sá»± rÃµ rÃ ng hoáº·c cÃ³ má»©c Ä‘á»™ chá»“ng láº¥n nháº¥t Ä‘á»‹nh.

Khi xÃ©t riÃªng tá»«ng cá»¥m, chá»‰ cÃ³ cá»¥m 11 Ä‘áº¡t Silhouette Score vÆ°á»£t trá»™i (~0.23), cho tháº¥y cá»¥m nÃ y cÃ³ tÃ­nh tÃ¡ch biá»‡t rÃµ rÃ ng vÃ  ná»™i táº¡i cháº·t cháº½.
NgÆ°á»£c láº¡i, cÃ¡c cá»¥m nhÆ° 6 vÃ  8 cÃ³ Ä‘iá»ƒm Silhouette Ã¢m, chá»©ng tá» cÃ¡c Ä‘iá»ƒm trong nhá»¯ng cá»¥m nÃ y cÃ³ xu hÆ°á»›ng gáº§n hÆ¡n vá»›i cá»¥m lÃ¢n cáº­n hÆ¡n lÃ  vá»›i cá»¥m hiá»‡n táº¡i â†’ phÃ¢n cá»¥m kÃ©m hiá»‡u quáº£.


### 2. Tá»· lá»‡ nhiá»…u (Noise Ratio)
```{r}
# TÃ­nh tá»· lá»‡ nhiá»…u
noise_ratio <- sum(db_result$cluster == 0) / length(db_result$cluster)
cat("Tá»· lá»‡ nhiá»…u:", noise_ratio, "\n")

```
```{r}
noise_count <- sum(db_result$cluster == 0)
clustered_count <- sum(db_result$cluster != 0)

# Dá»¯ liá»‡u cho biá»ƒu Ä‘á»“ trÃ²n
pie_data <- data.frame(
  category = c("Nhiá»…u", "PhÃ¢n cá»¥m"),
  count = c(noise_count, clustered_count)
)

# Táº£i thÆ° viá»‡n ggplot2 náº¿u chÆ°a cÃ³
library(ggplot2)

# Váº½ biá»ƒu Ä‘á»“ trÃ²n
ggplot(pie_data, aes(x = "", y = count, fill = category)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  labs(title = "Tá»‰ lá»‡ nhiá»…u trong káº¿t quáº£ phÃ¢n cá»¥m DBSCAN") +
  theme_void() +
  scale_fill_manual(values = c("Nhiá»…u" = "lightpink", "PhÃ¢n cá»¥m" = "lightblue"))
```

Trong quÃ¡ trÃ¬nh phÃ¢n cá»¥m vá»›i DBSCAN, tá»· lá»‡ Ä‘iá»ƒm dá»¯ liá»‡u khÃ´ng thuá»™c báº¥t ká»³ cá»¥m nÃ o lÃ  khoáº£ng 2.10%, Tá»· lá»‡ nÃ y tÆ°Æ¡ng Ä‘á»‘i tháº¥p, cho tháº¥y dá»¯ liá»‡u RFM Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ tá»‘t, 
### 3. Davies-Bouldin Index vÃ  Calinski-Harabasz Index

```{r}
# TÃ­nh Calinski-Harabasz Index (chá»‰ cho cÃ¡c Ä‘iá»ƒm khÃ´ng pháº£i nhiá»…u)
if (length(unique(db_result$cluster[non_noise])) > 1) {
  ch_index <- calinhara(scaled_data[non_noise, ], 
                        db_result$cluster[non_noise])
  cat("Calinski-Harabasz Index:", ch_index, "\n")
} else {
  cat("KhÃ´ng thá»ƒ tÃ­nh CH Index: chá»‰ tÃ¬m tháº¥y 1 cá»¥m (khÃ´ng tÃ­nh nhiá»…u)\n")
}
```
GiÃ¡ trá»‹: 593.7985
Chá»‰ sá»‘ Calinski-Harabasz cÃ ng cao chá»©ng tá» cá»¥m ná»™i táº¡i cÃ ng cháº·t cháº½ vÃ  cá»¥m vá»›i cá»¥m cÃ ng cÃ¡ch biá»‡t. Trong trÆ°á»ng há»£p nÃ y, chá»‰ sá»‘ Ä‘áº¡t má»©c khÃ¡ cao cho tháº¥y sá»± tÃ¡ch biá»‡t tá»•ng thá»ƒ giá»¯a cÃ¡c cá»¥m lÃ  tÆ°Æ¡ng Ä‘á»‘i á»•n, máº·c dÃ¹ khÃ´ng pháº£n Ã¡nh rÃµ cÃ¡c Ä‘iá»ƒm nhiá»…u hoáº·c gÃ¡n sai cá»¥m nhÆ° Silhouette Score.

## Trá»±c quan hÃ³a káº¿t quáº£ phÃ¢n cá»¥m DBSCAN

UMAP (Uniform Manifold Approximation and Projection) lÃ  má»™t phÆ°Æ¡ng phÃ¡p giáº£m chiá»u dá»¯ liá»‡u ráº¥t hiá»‡u quáº£, Ä‘áº·c biá»‡t khi trá»±c quan hÃ³a cÃ¡c káº¿t quáº£ phÃ¢n cá»¥m trong khÃ´ng gian 2D. Khi Ã¡p dá»¥ng vÃ o káº¿t quáº£ phÃ¢n cá»¥m DBSCAN, UMAP giÃºp lÃ m rÃµ cáº¥u trÃºc vÃ  má»‘i quan há»‡ giá»¯a cÃ¡c Ä‘iá»ƒm dá»¯ liá»‡u mÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p giáº£m chiá»u khÃ¡c cÃ³ thá»ƒ khÃ´ng phÃ¡t hiá»‡n ra. DBSCAN, vá»‘n lÃ  phÆ°Æ¡ng phÃ¡p phÃ¢n cá»¥m khÃ´ng cÃ³ sáºµn sá»‘ lÆ°á»£ng cá»¥m trÆ°á»›c, cÃ³ thá»ƒ táº¡o ra cÃ¡c cá»¥m vá»›i hÃ¬nh dáº¡ng phá»©c táº¡p vÃ  cÃ³ thá»ƒ cÃ³ má»™t sá»‘ Ä‘iá»ƒm nhiá»…u (noise). Váº­y nÃªn nhÃ³m sá»­ dá»¥ng UMAP trong trÆ°á»ng há»£p nÃ y giÃºp chuyá»ƒn cÃ¡c Ä‘áº·c tÃ­nh khÃ´ng gian cao chiá»u cá»§a dá»¯ liá»‡u vÃ o khÃ´ng gian 2D má»™t cÃ¡ch trá»±c quan, giá»¯ Ä‘Æ°á»£c cÃ¡c cáº¥u trÃºc cáº­n ká» vÃ  phÃ¢n tÃ¡ch rÃµ rÃ ng giá»¯a cÃ¡c cá»¥m.

```{r message=FALSE, warning=FALSE}
library(umap)
# Giáº£m chiá»u báº±ng UMAP
set.seed(42)  # Giá»¯ káº¿t quáº£ á»•n Ä‘á»‹nh
umap_result <- umap(scaled_data_DB)

# Táº¡o dataframe 2D tá»« káº¿t quáº£ UMAP
umap_df <- as.data.frame(umap_result$layout)
colnames(umap_df) <- c("UMAP1", "UMAP2")

# GÃ¡n nhÃ£n cá»¥m tá»« DBSCAN (náº¿u cÃ³)
umap_df$cluster <- factor(db_result$cluster)  # Báº¡n Ä‘Ã£ cháº¡y db_result á»Ÿ bÆ°á»›c trÆ°á»›c rá»“i

# Váº½ biá»ƒu Ä‘á»“ trá»±c quan cá»¥m
ggplot(umap_df, aes(x = UMAP1, y = UMAP2, color = cluster)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(title = "Trá»±c quan hÃ³a phÃ¢n cá»¥m DBSCAN báº±ng UMAP",
       x = "UMAP1", y = "UMAP2") +
  scale_color_brewer(palette = "Set1") +
  theme_minimal()
```
**Nháº­n xÃ©t:**

CÃ¡c cá»¥m cÃ³ hÃ¬nh dáº¡ng tá»± nhiÃªn, kÃ­ch thÆ°á»›c khÃ¡c nhau â€“ Ä‘Ãºng vá»›i Ä‘áº·c Ä‘iá»ƒm mÃ  DBSCAN Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ xá»­ lÃ½.

Pháº§n lá»›n cá»¥m tÃ¡ch biá»‡t rÃµ rÃ ng, Ä‘áº·c biá»‡t lÃ  cÃ¡c cá»¥m lá»›n nhÆ° cá»¥m 2, 5, 6 vÃ  11 cho tháº¥y:

DBSCAN Ä‘Ã£ thÃ nh cÃ´ng trong viá»‡c nháº­n diá»‡n cÃ¡c khu vá»±c cÃ³ máº­t Ä‘á»™ cao rÃµ rÃ ng trong khÃ´ng gian Ä‘Ã£ Ä‘Æ°á»£c UMAP chiáº¿u xuá»‘ng.

Cá»¥m nhiá»…u (cluster 0) bao gá»“m cÃ¡c Ä‘iá»ƒm ráº£i rÃ¡c: cho tháº¥y DBSCAN khÃ´ng Ã©p buá»™c cÃ¡c Ä‘iá»ƒm ngoáº¡i lai vÃ o cá»¥m nÃ o cáº£.






