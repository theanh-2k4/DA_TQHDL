---
title: "Clean and RFM - DBSCAn"
author: "Nguy·ªÖn Nh·∫≠t Nam, H√† Th·∫ø Anh"
output:
  html_document:
    toc: true
    toc_depth: '3'
    df_print: paged
  word_document:
    toc: true
    toc_depth: 3
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: 3
    number_sections: true
    fig_caption: true
    fig_height: 5
    fig_width: 7
    highlight: tango
header-includes:
- \usepackage{graphicx}
- \usepackage{fontspec}
- \setmainfont{Times New Roman}
---
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
Sys.setlocale("LC_ALL", "English_United States.UTF-8")

```

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(cluster)
library(factoextra)
library(lubridate)
library(scales)
library(psych)
library(readxl)
library(dplyr)
library(ggplot2)
library(plotly)
```


# Ti·ªÅn x·ª≠ l√Ω d·ªØ li·ªáu

```{r message=FALSE, warning=FALSE}
# ƒê·ªçc d·ªØ li·ªáu
df <- read_excel("Online Retail.xlsx")
head(df)  

```

  InvoiceNo: M√£ ƒë∆°n h√†ng 
  
  StockCode: M√£ s·∫£n ph·∫©m 
  
  Description: M√¥ t·∫£ s·∫£n ph·∫©m 
  
  Quantity: S·ªë l∆∞·ª£ng s·∫£n ph·∫©m 
  
  InvoiceDate: Ng√†y h√≥a ƒë∆°n 
  
  UnitPrice: Gi√° s·∫£n ph·∫©m tr√™n m·ªói ƒë∆°n v·ªã 
  
  CustomerID: M√£ kh√°ch h√†ng 
  
  Country: Qu·ªëc gia c·ªßa kh√°ch h√†ng
  

```{r}
#Ki·ªÉm tra ki·ªÉu d·ªØ li·ªáu
str(df)
```


```{r}
# th·ªëng k√™ m√¥ t·∫£ d·ªØ li·ªáu 
describe(df)

```

```{r}
# Th·ªëng k√™ data object 
summary(df[, sapply(df, is.character)])
```
```{r}
#ki·ªÉm tra d·ªØ li·ªáu thi·∫øu 
colSums(is.na(df))
```


```{r}
# Ki·ªÉm tra gi√° tr·ªã thi·∫øu c·ªßa CustomerID
df_na <- df[is.na(df$CustomerID), ]
print(df_na[sample(nrow(df_na), 10), ], width = Inf)
```

```{r}
# Chuy·ªÉn 'InvoiceNo' v·ªÅ ki·ªÉu chu·ªói
df$InvoiceNo <- as.character(df$InvoiceNo)
#L·ªçc ra nh·ªØng d√≤ng KH√îNG c√≥ InvoiceNo ƒë√∫ng 6 ch·ªØ s·ªë
df[!grepl("^\\d{6}$", df$InvoiceNo), ]

#Ki·ªÉm tra k√≠ t·ª± kh√°c trong c·ªôt InvoiceNo 
unique(gsub("[0-9]", "", df$InvoiceNo))

# ki·ªÉm tra col 'InvoiceNo' c√≥ gi√° tr·ªã n√†o b·∫Øt ƒë·∫ßu b·∫±ng k√≠ t·ª± 'A' ko
df[grepl("^A", df$InvoiceNo), ]
```
```{r}
# ƒê·∫£m b·∫£o 'StockCode' l√† ki·ªÉu chu·ªói
df$StockCode <- as.character(df$StockCode)
# L·ªçc nh·ªØng d√≤ng KH√îNG ph·∫£i 5 ch·ªØ s·ªë ho·∫∑c 5 ch·ªØ s·ªë + ch·ªØ c√°i
mask <- !(grepl("^\\d{5}$", df$StockCode) | grepl("^\\d{5}[a-zA-Z]+$", df$StockCode))
# L·∫•y c√°c StockCode sai ƒë·ªãnh d·∫°ng v√† lo·∫°i tr√πng
invalid_stockcodes <- unique(df$StockCode[mask])
# Hi·ªÉn th·ªã k·∫øt qu·∫£
print(invalid_stockcodes)
# L·ªçc nh·ªØng d√≤ng c√≥ ch·ª©a chu·ªói 'DOT'
df_with_DOT <- df[grepl("DOT", df$StockCode), ]
# Hi·ªÉn th·ªã k·∫øt qu·∫£
print(df_with_DOT)
```

 **Stock Code**

- **Include** üü¢ ‚Üí Gi·ªØ l·∫°i ƒë·ªÉ ph√¢n t√≠ch ho·∫∑c clustering.  
- **Exclude** ‚ùå ‚Üí Lo·∫°i b·ªè ho√†n to√†n, kh√¥ng d√πng ƒë·ªÉ ph√¢n t√≠ch.  
- **Exclude from clustering** üö´ ‚Üí Kh√¥ng d√πng ƒë·ªÉ ph√¢n nh√≥m nh∆∞ng c√≥ th·ªÉ tham kh·∫£o.  
- **Exclude for now** ‚è≥ ‚Üí T·∫°m lo·∫°i b·ªè, c√≥ th·ªÉ xem x√©t l·∫°i sau. 

- **StockCode** is meant to follow the pattern `[0-9]{5}` but seems to have legit values for `[0-9]{5}[a-zA-Z]+`.  
&nbsp;&nbsp;&nbsp;&nbsp; **Also contains other values:** 



| Code             | Description                                                                 | Action                      |
|------------------|-----------------------------------------------------------------------------|-----------------------------|
| POST            | Not listed previously, likely a postage-related transaction                | Exclude for now             |
| D               | Looks valid, represents discount values                                    | Exclude from clustering     |
| C2              | Carriage transaction - not sure what this means                           | Exclude from clustering     |
| DOT             | Looks valid, represents postage charges                                   | Exclude from clustering     |
| M or m          | Looks valid, represents manual transactions                               | Exclude from clustering     |
| BANK CHARGES or B | Bank charges                                                           | Exclude from clustering     |
| S               | Samples sent to customer                                                 | Exclude from clustering     |
| AMAZONFEE       | Looks like fees for Amazon shipping or something                         | Exclude for now             |
| DCGS0076        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0003        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| gift_0001_40    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| DCGS0070        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| m               | Looks valid, represents manual transactions                              | Exclude from clustering     |
| gift_0001_50    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| gift_0001_30    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| gift_0001_20    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| DCGS0055        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0072        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0074        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0069        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0057        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGSSBOY        | Possible category or bundle-related code                                 | Exclude for now             |
| DCGSSGIRL       | Possible category or bundle-related code                                 | Exclude for now             |
| gift_0001_10    | Purchases with gift cards, might be interesting for another analysis, but no customer data | Exclude |
| PADS            | Looks like a legit stock code for padding                                | Include                     |
| DCGS0004        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0073        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0071        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0068        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0067        | Variant of DCGS, likely falls under the same category                    | Exclude from clustering     |
| DCGS0066P       | Variant of DCGS, possibly a special category                            | Exclude from clustering     |
| B               | Bank charges                                                             | Exclude from clustering     |
| CRUK            | Unknown, possibly a charity-related code                                | Exclude for now             |


# X·ª≠ l√Ω d·ªØ li·ªáu 

```{r}
# Chuy·ªÉn InvoiceDate th√†nh ki·ªÉu Date
df$InvoiceDate <- as.Date(df$InvoiceDate)
str(df)
```

```{r}
# 1. G√°n l·∫°i df g·ªëc
df_cleaned <- df
# Lo·∫°i b·ªè to√†n b·ªô d√≤ng ch·ª©a b·∫•t k·ª≥ k√Ω t·ª± KH√îNG PH·∫¢I s·ªë (0‚Äì9)
df_cleaned <- df_cleaned[grepl("^[0-9]+$", df_cleaned$InvoiceNo), ]

```

```{r}
# Ki·ªÉm tra c√≤n ch·ªØ c√°i kh√¥ng?
any(grepl("[A-Za-z]", df_cleaned$InvoiceNo))  # Ph·∫£i tr·∫£ FALSE

# Ki·ªÉm tra c√≤n k√Ω t·ª± ƒë·∫∑c bi·ªát kh√¥ng?
any(grepl("[^0-9]", df_cleaned$InvoiceNo))    # Ph·∫£i tr·∫£ FALSE
```

```{r}

# T·∫°o ƒëi·ªÅu ki·ªán gi·ªØ l·∫°i c√°c StockCode h·ª£p l·ªá:
mask <- grepl("^\\d{5,6}$", df_cleaned$StockCode) |           # To√†n s·ªë, 5-6 ch·ªØ s·ªë
        grepl("^\\d{5}[A-Za-z]$", df_cleaned$StockCode) |     # 5 s·ªë + 1 ch·ªØ c√°i
        df_cleaned$StockCode == "APADSS"                      # M√£ ƒë·∫∑c bi·ªát

# √Åp d·ª•ng l·ªçc
df_cleaned <- df_cleaned[mask, ]

df_cleaned
```
```{r}
sum(is.na(df$CustomerID))  # ƒë·∫øm s·ªë d√≤ng b·ªã thi·∫øu
```

```{r}
# X√≥a c√°c d√≤ng c√≥ NA ·ªü c·ªôt CustomerID
df_cleaned <- df_cleaned[!is.na(df_cleaned$CustomerID), ]

nrow(df) - nrow(df_cleaned)  # s·ªë d√≤ng ƒë√£ b·ªã x√≥a

colSums(is.na(df_cleaned))
```

```{r}
# th·ªëng k√™ data sau khi drop na
summary(df_cleaned)

```

**Nh·∫≠n x√©t t·ªïng quan v·ªÅ d·ªØ li·ªáu df_cleaned:**




```{r}
# ki·ªÉm tra gi√° tr·ªã b·∫±ng 0 c·ªßa col 'UnitPrice'
sum(df_cleaned$UnitPrice == 0)
# ch·ªâ l·∫•y gi√° tr·ªã kh√°c 0 
df_cleaned <- df_cleaned[df_cleaned$UnitPrice > 0, ]
#Ki·ªÉm tra 
summary(df_cleaned)

```

```{r}
#T√≠nh t·ª∑ l·ªá ph·∫ßn trƒÉm s·ªë d√≤ng c√≤n l·∫°i trong df_cleaned so v·ªõi t·ªïng s·ªë d√≤ng ban ƒë·∫ßu trong df.
sprintf("%.2f%%", nrow(df_cleaned) / nrow(df) * 100)
```


```{r}
##Tr·ª±c quan h√≥a
# S·ªë d√≤ng ban ƒë·∫ßu v√† sau khi l√†m s·∫°ch
total_rows <- nrow(df)
cleaned_rows <- nrow(df_cleaned)
removed_rows <- total_rows - cleaned_rows
# T·∫°o dataframe ƒë·ªÉ v·∫Ω
summary_df <- data.frame(
  Tr·∫°ng_th√°i = c("Gi·ªØ l·∫°i", "ƒê√£ lo·∫°i"),
  S·ªë_l∆∞·ª£ng = c(cleaned_rows, removed_rows)
)
# V·∫Ω bi·ªÉu ƒë·ªì
barplot(
  summary_df$S·ªë_l∆∞·ª£ng,
  names.arg = summary_df$Tr·∫°ng_th√°i,
  col = c("skyblue", "salmon"),
  main = "So s√°nh s·ªë d√≤ng tr∆∞·ªõc v√† sau khi l√†m s·∫°ch",
  ylab = "S·ªë d√≤ng",
  ylim = c(0, max(summary_df$S·ªë_l∆∞·ª£ng) * 1.1)
)
# Hi·ªÉn th·ªã s·ªë li·ªáu tr√™n c·ªôt
text(
  x = c(1, 2),
  y = summary_df$S·ªë_l∆∞·ª£ng,
  labels = summary_df$S·ªë_l∆∞·ª£ng,
  pos = 3,
  cex = 1.2
)
```

##Analysis RFM 

```{r}
# t·∫°o c·ªôt t·ªïng chi ti√™u l√†m Monetary (t·ªïng chi ti√™u)
df_cleaned$SalesLineTotal <- df_cleaned$Quantity * df_cleaned$UnitPrice
# Hi·ªÉn th·ªã k·∫øt qu·∫£
print(df_cleaned, width = Inf)
```


```{r}
aggregated_df <- summarise(
  group_by(df_cleaned, CustomerID),
  MonetaryValue = sum(SalesLineTotal, na.rm = TRUE),
  Frequency = n_distinct(InvoiceNo),
  LastInvoiceDate = max(InvoiceDate)
)
```


```{r}
# T√≠nh Recency
analysis_date <- as.Date(max(df_cleaned$InvoiceDate))
aggregated_df$Recency <- as.numeric(analysis_date - aggregated_df$LastInvoiceDate)

print(aggregated_df, width = Inf)

```

```{r}
# Thi·∫øt l·∫≠p b·ªë c·ª•c 1 h√†ng 3 bi·ªÉu ƒë·ªì
par(mfrow = c(1, 3), mar = c(4, 4, 3, 1))  # 1 d√≤ng, 3 c·ªôt

# Bi·ªÉu ƒë·ªì 1: Monetary Value
hist(aggregated_df$MonetaryValue,
     breaks = 10,
     col = "skyblue",
     border = "red",
     main = "Monetary Value Distribution",
     xlab = "Monetary Value",
     ylab = "Count")

# Bi·ªÉu ƒë·ªì 2: Frequency
hist(aggregated_df$Frequency,
     breaks = 10,
     col = "lightgreen",
     border = "red",
     main = "Frequency Distribution",
     xlab = "Frequency",
     ylab = "Count")

# Bi·ªÉu ƒë·ªì 3: Recency
hist(aggregated_df$Recency,
     breaks = 20,
     col = "yellow",
     border = "red",
     main = "Recency Distribution",
     xlab = "Recency",
     ylab = "Count")

# Reset layout v·ªÅ m·∫∑c ƒë·ªãnh (1 bi·ªÉu ƒë·ªì/khung)
par(mfrow = c(1, 1))
```
**Nh·∫≠n x√©t**

  - **Monetary Value Distribution (Gi√° tr·ªã chi ti√™u):**
  
      * Ph√¢n b·ªë r·∫•t l·ªách ph·∫£i (right-skewed).

      * Ph·∫ßn l·ªõn kh√°ch h√†ng c√≥ t·ªïng chi ti√™u (Monetary) r·∫•t th·∫•p (ƒëa s·ªë < 10,000).

      * Ch·ªâ m·ªôt s·ªë √≠t kh√°ch chi ti√™u r·∫•t cao (c√≥ gi√° tr·ªã t·ªõi 250,000+), t·∫°o ra outlier r·∫•t m·∫°nh.
      
  - **K·∫øt lu·∫≠n:**
    
      * T·∫≠p kh√°ch h√†ng c√≥ s·ª± kh√°c bi·ªát l·ªõn v·ªÅ gi√° tr·ªã ‚Äì ph√π h·ª£p ƒë·ªÉ ph√¢n nh√≥m (clustering).
    
      * N√™n xem x√©t log-transform ho·∫∑c winsorizing tr∆∞·ªõc khi d√πng cho m√¥ h√¨nh.
    
  - **Frequency Distribution (T·∫ßn su·∫•t mua h√†ng):**

      * C·ª±c k·ª≥ l·ªách ph·∫£i: g·∫ßn nh∆∞ t·∫•t c·∫£ kh√°ch ch·ªâ mua 1‚Äì2 l·∫ßn.

      * R·∫•t √≠t kh√°ch h√†ng mua t·ª´ 10 l·∫ßn tr·ªü l√™n (hi·∫øm c√≥ >50).

      * M·ªôt v√†i gi√° tr·ªã l·ªõn (outlier) v·∫´n t·ªìn t·∫°i.

  - **K·∫øt lu·∫≠n:**
  
      * Ph·∫ßn l·ªõn kh√°ch h√†ng kh√¥ng trung th√†nh ‚Üí ch·ªâ mua 1 l·∫ßn.

      * R·∫•t c·∫ßn ph√°t tri·ªÉn nh√≥m kh√°ch ‚Äúfrequent buyers‚Äù (n·∫øu mu·ªën tƒÉng CLV).

      * C√≥ th·ªÉ t·∫°o ch√≠nh s√°ch ∆∞u ƒë√£i t·∫ßn su·∫•t cho nh√≥m ti·ªÅm nƒÉng.

  - **Recency Distribution (Kho·∫£ng th·ªùi gian k·ªÉ t·ª´ l·∫ßn mua g·∫ßn nh·∫•t):**

      * Ph√¢n b·ªë c≈©ng l·ªách ph·∫£i nh∆∞ng nh·∫π h∆°n.

      * Nhi·ªÅu kh√°ch h√†ng m·ªõi mua g·∫ßn ƒë√¢y (Recency th·∫•p) ‚Üí t·∫≠p trung ·ªü kho·∫£ng 0‚Äì50 ng√†y.

      * C√†ng xa (Recency cao), s·ªë l∆∞·ª£ng kh√°ch gi·∫£m d·∫ßn ‚Üí bi·ªÉu hi·ªán t·ªët.

  - **K·∫øt lu·∫≠n:**
  
      * C√≥ nhi·ªÅu kh√°ch h√†ng m·ªõi ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y.

      * C∆° h·ªôi r·∫•t t·ªët ƒë·ªÉ ch·∫°y l·∫°i remarketing ho·∫∑c t√°i k√≠ch ho·∫°t kh√°ch c≈©.

      * T·∫≠p kh√°ch c≈© (Recency > 250) c√≥ th·ªÉ l√† kh√°ch r·ªùi b·ªè.
      
**ki·ªÉm tra outlier**

```{r}
data_outliers <- aggregated_df
```

```{r}
# ƒê·∫∑t layout: 1 h√†ng, 3 bi·ªÉu ƒë·ªì
par(mfrow = c(1, 3), mar = c(4, 4, 3, 1))

# Boxplot 1: MonetaryValue
boxplot(aggregated_df$MonetaryValue,
        col = "skyblue",
        main = "Monetary Value Boxplot",
        xlab = "Monetary Value")

# Boxplot 2: Frequency
boxplot(aggregated_df$Frequency,
        col = "lightgreen",
        main = "Frequency Boxplot",
        xlab = "Frequency")

# Boxplot 3: Recency
boxplot(aggregated_df$Recency,
        col = "salmon",
        main = "Recency Boxplot",
        xlab = "Recency")

# Reset l·∫°i layout v·ªÅ m·∫∑c ƒë·ªãnh (1 bi·ªÉu ƒë·ªì)
par(mfrow = c(1, 1))
```


```{r}
# T√≠nh Q1, Q3 v√† IQR cho MonetaryValue
M_Q1 <- quantile(aggregated_df$MonetaryValue, 0.25)
M_Q3 <- quantile(aggregated_df$MonetaryValue, 0.75)
M_IQR <- M_Q3 - M_Q1

# L·ªçc c√°c d√≤ng l√† outlier
monetary_outliers_df <- aggregated_df[
  aggregated_df$MonetaryValue < (M_Q1 - 1.5 * M_IQR) |
  aggregated_df$MonetaryValue > (M_Q3 + 1.5 * M_IQR),
]

# Xem m√¥ t·∫£ d·ªØ li·ªáu outlier
summary(monetary_outliers_df)

```

```{r}
# T√≠nh Q1, Q3 v√† IQR cho Frequency
F_Q1 <- quantile(aggregated_df$Frequency, 0.25)
F_Q3 <- quantile(aggregated_df$Frequency, 0.75)
F_IQR <- F_Q3 - F_Q1

# L·ªçc c√°c d√≤ng l√† outlier theo Frequency
frequency_outliers_df <- aggregated_df[
  aggregated_df$Frequency < (F_Q1 - 1.5 * F_IQR) |
  aggregated_df$Frequency > (F_Q3 + 1.5 * F_IQR),
]

# Th·ªëng k√™ d·ªØ li·ªáu outlier
summary(frequency_outliers_df)

```

```{r}
# Lo·∫°i b·ªè outlier b·∫±ng c√°ch gi·ªØ l·∫°i c√°c d√≤ng KH√îNG n·∫±m trong monetary v√† frequency outliers

# L·∫•y ch·ªâ s·ªë h√†ng (index) c·∫ßn lo·∫°i b·ªè
outlier_indices <- union(
  which(aggregated_df$MonetaryValue < (M_Q1 - 1.5 * M_IQR) | aggregated_df$MonetaryValue > (M_Q3 + 1.5 * M_IQR)),
  which(aggregated_df$Frequency < (F_Q1 - 1.5 * F_IQR) | aggregated_df$Frequency > (F_Q3 + 1.5 * F_IQR))
)

# Gi·ªØ l·∫°i c√°c d√≤ng kh√¥ng n·∫±m trong ch·ªâ s·ªë outlier
non_outliers_df <- aggregated_df[-outlier_indices, ]

# Ki·ªÉm tra l·∫°i
summary(non_outliers_df)

```


```{r}
# Tr·ª±c quan sau khi lo·∫°i b·ªè 
# Chia khung h√¨nh ra 1 d√≤ng 3 bi·ªÉu ƒë·ªì
par(mfrow = c(1, 3), mar = c(4, 4, 3, 1))

# Boxplot 1: Monetary Value
boxplot(non_outliers_df$MonetaryValue,
        col = "skyblue",
        main = "Monetary Value Boxplot",
        xlab = "Monetary Value")

# Boxplot 2: Frequency
boxplot(non_outliers_df$Frequency,
        col = "lightgreen",
        main = "Frequency Boxplot",
        xlab = "Frequency")

# Boxplot 3: Recency
boxplot(non_outliers_df$Recency,
        col = "salmon",
        main = "Recency Boxplot",
        xlab = "Recency")

# Reset l·∫°i layout v·ªÅ m·∫∑c ƒë·ªãnh
par(mfrow = c(1, 1))
```


```{r}
# V·∫Ω scatter plot 3D
plot_ly(non_outliers_df,
        x = ~MonetaryValue,
        y = ~Frequency,
        z = ~Recency,
        type = 'scatter3d',
        mode = 'markers',
        marker = list(size = 2, color = 'blue')) %>%
  layout(
    title = list(text = "3D Scatter Plot of Customer Data"),
    scene = list(
      xaxis = list(title = "Monetary"),
      yaxis = list(title = "Frequency"),
      zaxis = list(title = "Recency")
    )
  )


```
```{r}
# Chu·∫©n h√≥a c√°c c·ªôt MonetaryValue, Frequency, Recency
scaled_data <- scale(non_outliers_df[, c("MonetaryValue", "Frequency", "Recency")])
```

```{r}
# Chuy·ªÉn matrix chu·∫©n h√≥a v·ªÅ data.frame
scaled_data_df <- as.data.frame(scaled_data)

# ƒê·∫∑t l·∫°i t√™n c·ªôt
colnames(scaled_data_df) <- c("MonetaryValue", "Frequency", "Recency")

# G√°n l·∫°i rownames n·∫øu c·∫ßn gi·ªØ index
rownames(scaled_data_df) <- rownames(non_outliers_df)
# Xem k·∫øt qu·∫£
head(scaled_data_df)
```

```{r}
plot_ly(scaled_data_df,
        x = ~MonetaryValue,
        y = ~Frequency,
        z = ~Recency,
        type = "scatter3d",
        mode = "markers",
        marker = list(size = 2, color = 'blue')) %>%
  layout(title = "3D Scatter Plot of Scaled Customer Data")
```

# Ph√¢n c·ª•m d·ªØ li·ªáu s·ª≠ d·ª•ng DBSCAN

**(Density-Based Spatial Clustering of Applications with Noise)** l√† m·ªôt thu·∫≠t to√°n ph√¢n c·ª•m d·ª±a tr√™n m·∫≠t ƒë·ªô. ƒê∆∞·ª£c gi·ªõi thi·ªáu b·ªüi Martin Ester, Hans-Peter Kriegel, J√∂rg Sander, v√† Xiaowei Xu v√†o nƒÉm 1996, DBSCAN ƒë√£ tr·ªü th√†nh m·ªôt trong nh·ªØng thu·∫≠t to√°n ph√¢n c·ª•m ph·ªï bi·∫øn nh·∫•t trong h·ªçc m√°y kh√¥ng gi√°m s√°t.

Kh√°c v·ªõi K-Means d·ª±a tr√™n kho·∫£ng c√°ch Euclidean v√† y√™u c·∫ßu x√°c ƒë·ªãnh tr∆∞·ªõc s·ªë c·ª•m, DBSCAN nh√≥m c√°c ƒëi·ªÉm d·ª±a tr√™n m·∫≠t ƒë·ªô c·ªßa ch√∫ng trong kh√¥ng gian d·ªØ li·ªáu. ƒêi·ªÅu n√†y gi√∫p DBSCAN c√≥ nhi·ªÅu ∆∞u ƒëi·ªÉm:

- Kh√¥ng c·∫ßn bi·∫øt tr∆∞·ªõc s·ªë l∆∞·ª£ng c·ª•m

- Ph√°t hi·ªán ƒë∆∞·ª£c c·ª•m c√≥ h√¨nh d·∫°ng t√πy √Ω, kh√¥ng ch·ªâ c·ª•m h√¨nh c·∫ßu

- C√≥ kh·∫£ nƒÉng ph√°t hi·ªán v√† lo·∫°i b·ªè nhi·ªÖu (outliers)

- Hi·ªáu qu·∫£ v·ªõi b·ªô d·ªØ li·ªáu l·ªõn

## X√°c ƒë·ªãnh tham s·ªë cho DBSCAN

B·ªô d·ªØ li·ªáu Online Retail qua b∆∞·ªõc ti·ªÅn x·ª≠ l√Ω ƒë∆∞·ª£c l∆∞u v√†o scaled_data, tr∆∞·ªõc khi ti·∫øn h√†nh ph√¢n c·ª•m ta c·∫ßn x√°c ƒë·ªãnh c√°c tham s·ªë cho DBSCAN

### X√°c ƒë·ªãnh MinPts

MinPts x√°c ƒë·ªãnh s·ªë l∆∞·ª£ng ƒëi·ªÉm t·ªëi thi·ªÉu c·∫ßn c√≥ trong v√πng l√¢n c·∫≠n ƒë·ªÉ m·ªôt ƒëi·ªÉm ƒë∆∞·ª£c coi l√† ƒëi·ªÉm l√µi.th√¥ng th∆∞·ªùng ch√∫ng ta ch·ªçn MinPts ‚â• D + 1, trong ƒë√≥ D l√† s·ªë chi·ªÅu c·ªßa d·ªØ li·ªáu, trong b·ªô d·ªØ li·ªáu n√†y ta d√πng ba ch·ªâ s·ªë l√† RFM ƒë·ªÉ ph√¢n c·ª•m n√™n MinPts = 4 l√† l·ª±a ch·ªçn h·ª£p l√Ω.

### X√°c ƒë·ªãnh Epsilon (Œµ)

Epsilon x√°c ƒë·ªãnh b√°n k√≠nh v√πng l√¢n c·∫≠n. ƒê√¢y l√† tham s·ªë kh√≥ x√°c ƒë·ªãnh nh·∫•t v√† c√≥ ·∫£nh h∆∞·ªüng l·ªõn ƒë·∫øn k·∫øt qu·∫£ ph√¢n c·ª•m.

ƒê·ªÉ x√°c ƒë·ªãnh Epsilon ta d√πng ph∆∞∆°ng ph√°p k-distance graph, c√°ch ph·ªï bi·∫øn nh·∫•t ƒë·ªÉ x√°c ƒë·ªãnh Œµ ph√π h·ª£p, c√°c b∆∞·ªõc x√°c ƒë·ªãnh b·∫±ng ph∆∞∆°ng ph√°p k-distance graph bao g·ªìm:

1. V·ªõi m·ªói ƒëi·ªÉm, t√≠nh kho·∫£ng c√°ch ƒë·∫øn ƒëi·ªÉm th·ª© k g·∫ßn nh·∫•t (k = MinPts - 1)

2. S·∫Øp x·∫øp c√°c kho·∫£ng c√°ch n√†y theo th·ª© t·ª± tƒÉng d·∫ßn

3. V·∫Ω ƒë·ªì th·ªã k-distance

4. T√¨m "ƒëi·ªÉm g·∫©y" (elbow point) - ƒëi·ªÉm m√† t·∫°i ƒë√≥ ƒë∆∞·ªùng cong c√≥ s·ª± thay ƒë·ªïi ƒë√°ng k·ªÉ

5. Ch·ªçn Œµ t·∫°i ƒëi·ªÉm g·∫©y n√†y

```{r message=FALSE, warning=FALSE, fig.cap="ƒê·ªì th·ªã x√°c ƒë·ªãnh Eps x·ª≠ d·ª•ng ph∆∞∆°ng ph√°p k-distance graph"}
# C√†i ƒë·∫∑t v√† n·∫°p c√°c g√≥i c·∫ßn thi·∫øt
library(dbscan)  # Cho thu·∫≠t to√°n DBSCAN
library(factoextra)  # Cho tr·ª±c quan h√≥a
library(fpc)  # Cho ƒë√°nh gi√° ph√¢n c·ª•m
library(ggplot2)  # Cho v·∫Ω bi·ªÉu ƒë·ªì
library(cluster)  # Cho h√†m silhouette


scaled_data_DB <- scale(non_outliers_df[, c("MonetaryValue", "Frequency", "Recency")])

# T√≠nh kho·∫£ng c√°ch k-nearest neighbors
k=3
knn_dists <- kNNdist(scaled_data_DB, k = k)

# S·∫Øp x·∫øp kho·∫£ng c√°ch v√† v·∫Ω ƒë·ªì th·ªã
eps_candidates <- sort(knn_dists)
plot(eps_candidates, type = "l", 
     xlab = "ƒêi·ªÉm d·ªØ li·ªáu (ƒë√£ s·∫Øp x·∫øp)",
     ylab = paste("Kho·∫£ng c√°ch ƒë·∫øn ƒëi·ªÉm th·ª©", k, "g·∫ßn nh·∫•t"),
     main = "Ph∆∞∆°ng ph√°p k-distance")

# T√¨m v·ªã tr√≠ c·ªßa ƒëi·ªÉm g·∫©y th·ªß c√¥ng (kho·∫£ng 0.5)
eps_value <- 0.4
eps_index <- which.min(abs(eps_candidates - eps_value))

# ƒê√°nh d·∫•u ƒëi·ªÉm g·∫©y
points(eps_index, eps_candidates[eps_index], col = "red", pch = 19)
text(eps_index, eps_candidates[eps_index], 
     labels = paste("Œµ ‚âà", round(eps_candidates[eps_index], 2)), 
     pos = 4, col = "red")

# V·∫Ω ƒë∆∞·ªùng th·∫≥ng t·∫°i ƒëi·ªÉm g·∫©y (th·ªß c√¥ng ·ªü m·ª©c 0.5)
abline(h = eps_value, col = "red", lty = 2)
```


Bi·ªÉu ƒë·ªì cho th·∫•y kho·∫£ng c√°ch tƒÉng d·∫ßn m·ªôt c√°ch ·ªïn ƒë·ªãnh cho ƒë·∫øn kho·∫£ng 3700 ƒëi·ªÉm, sau ƒë√≥ tƒÉng m·∫°nh, t·∫°o th√†nh m·ªôt ƒëi·ªÉm g·∫©y t·∫°i kho·∫£ng c√°ch 0.4. ƒêi·ªÉm n√†y ƒë∆∞·ª£c ch·ªçn l√†m gi√° tr·ªã epsilon (eps = 0.4) cho thu·∫≠t to√°n DBSCAN 

## Ph√¢n c·ª•m, ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng ph√¢n c·ª•m DBSCAN 

Khi ƒë√£ x√°c ƒë·ªãnh ƒë∆∞·ª£c c√°c tham s·ªë cho m√¥ h√¨nh ta c√≥ th·ªÉ d·ªÖ d√†ng ph√¢n c·ª•m d·ªØ li·ªáu x·ª≠ d·ª•ng th∆∞ vi·ªán DBSCAN, trong qu√° tr√¨nh ph√¢n c·ª•m d·ªØ li·ªáu RFM b·∫±ng thu·∫≠t to√°n DBSCAN v·ªõi c√°c tham s·ªë t·ªëi ∆∞u ƒë∆∞·ª£c l·ª±a ch·ªçn l√† eps = 0.4 v√† minPts = 4, ta ti·∫øn h√†nh ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng ph√¢n c·ª•m d·ª±a tr√™n hai ch·ªâ s·ªë ph·ªï bi·∫øn: Silhouette Score v√† Calinski-Harabasz Index, t·ª∑ l·ªá nhi·ªÖu (Noise Ratio) 

### Silhouette Score
```{r}
# √Åp d·ª•ng DBSCAN v·ªõi tham s·ªë ph√π h·ª£p
db_result <- dbscan(scaled_data_DB, eps = 0.4, MinPts = 4)
non_noise <- which(db_result$cluster > 0)

# N·∫øu s·ªë l∆∞·ª£ng c·ª•m h·ª£p l·ªá > 1 th√¨ m·ªõi t√≠nh Silhouette
if (length(unique(db_result$cluster[non_noise])) > 1) {
  
  # T√≠nh silhouette
  sil <- silhouette(db_result$cluster[non_noise], dist(scaled_data_DB[non_noise, ]))
  
  # T√≠nh ƒëi·ªÉm silhouette trung b√¨nh to√†n b·ªô
  avg_sil <- mean(sil[, 3], na.rm = TRUE)
  cat("ƒêi·ªÉm Silhouette trung b√¨nh:", avg_sil, "\n")
  
  # T·∫°o dataframe t·ª´ silhouette object
  sil_df <- as.data.frame(sil)
  
  # T√≠nh Silhouette trung b√¨nh theo t·ª´ng c·ª•m
  avg_sil_by_cluster <- sil_df %>%
    group_by(cluster) %>%
    summarise(avg_sil_width = mean(sil_width))
  
  # V·∫Ω bi·ªÉu ƒë·ªì c·ªôt
  dev.new(width = 10, height = 8)
  ggplot(avg_sil_by_cluster, aes(x = factor(cluster), y = avg_sil_width)) +
    geom_col(fill = "steelblue") +
    labs(title = "Silhouette Score theo t·ª´ng c·ª•m",
         x = "C·ª•m",
         y = "Silhouette Score trong t·ª´ng c·ª•m") +
    theme_minimal()
  
} else {
  cat("Kh√¥ng ƒë·ªß s·ªë c·ª•m ƒë·ªÉ t√≠nh Silhouette Score.\n")
}
```
ƒêi·ªÉm Silhouette trung b√¨nh: ~0.0496 cho th·∫•y c√°c c·ª•m ch∆∞a th·ª±c s·ª± r√µ r√†ng ho·∫∑c c√≥ m·ª©c ƒë·ªô ch·ªìng l·∫•n nh·∫•t ƒë·ªãnh.

Khi x√©t ri√™ng t·ª´ng c·ª•m, ch·ªâ c√≥ c·ª•m 11 ƒë·∫°t Silhouette Score v∆∞·ª£t tr·ªôi (~0.23), cho th·∫•y c·ª•m n√†y c√≥ t√≠nh t√°ch bi·ªát r√µ r√†ng v√† n·ªôi t·∫°i ch·∫∑t ch·∫Ω.
Ng∆∞·ª£c l·∫°i, c√°c c·ª•m nh∆∞ 6 v√† 8 c√≥ ƒëi·ªÉm Silhouette √¢m, ch·ª©ng t·ªè c√°c ƒëi·ªÉm trong nh·ªØng c·ª•m n√†y c√≥ xu h∆∞·ªõng g·∫ßn h∆°n v·ªõi c·ª•m l√¢n c·∫≠n h∆°n l√† v·ªõi c·ª•m hi·ªán t·∫°i ‚Üí ph√¢n c·ª•m k√©m hi·ªáu qu·∫£.


### 2. T·ª∑ l·ªá nhi·ªÖu (Noise Ratio)
```{r}
# T√≠nh t·ª∑ l·ªá nhi·ªÖu
noise_ratio <- sum(db_result$cluster == 0) / length(db_result$cluster)
cat("T·ª∑ l·ªá nhi·ªÖu:", noise_ratio, "\n")

```
```{r}
noise_count <- sum(db_result$cluster == 0)
clustered_count <- sum(db_result$cluster != 0)

# D·ªØ li·ªáu cho bi·ªÉu ƒë·ªì tr√≤n
pie_data <- data.frame(
  category = c("Nhi·ªÖu", "Ph√¢n c·ª•m"),
  count = c(noise_count, clustered_count)
)

# T·∫£i th∆∞ vi·ªán ggplot2 n·∫øu ch∆∞a c√≥
library(ggplot2)

# V·∫Ω bi·ªÉu ƒë·ªì tr√≤n
ggplot(pie_data, aes(x = "", y = count, fill = category)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  labs(title = "T·ªâ l·ªá nhi·ªÖu trong k·∫øt qu·∫£ ph√¢n c·ª•m DBSCAN") +
  theme_void() +
  scale_fill_manual(values = c("Nhi·ªÖu" = "lightpink", "Ph√¢n c·ª•m" = "lightblue"))
```

Trong qu√° tr√¨nh ph√¢n c·ª•m v·ªõi DBSCAN, t·ª∑ l·ªá ƒëi·ªÉm d·ªØ li·ªáu kh√¥ng thu·ªôc b·∫•t k·ª≥ c·ª•m n√†o l√† kho·∫£ng 2.10%, T·ª∑ l·ªá n√†y t∆∞∆°ng ƒë·ªëi th·∫•p, cho th·∫•y d·ªØ li·ªáu RFM ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω t·ªët, 
### 3. Davies-Bouldin Index v√† Calinski-Harabasz Index

```{r}
# T√≠nh Calinski-Harabasz Index (ch·ªâ cho c√°c ƒëi·ªÉm kh√¥ng ph·∫£i nhi·ªÖu)
if (length(unique(db_result$cluster[non_noise])) > 1) {
  ch_index <- calinhara(scaled_data[non_noise, ], 
                        db_result$cluster[non_noise])
  cat("Calinski-Harabasz Index:", ch_index, "\n")
} else {
  cat("Kh√¥ng th·ªÉ t√≠nh CH Index: ch·ªâ t√¨m th·∫•y 1 c·ª•m (kh√¥ng t√≠nh nhi·ªÖu)\n")
}
```
Gi√° tr·ªã: 593.7985
Ch·ªâ s·ªë Calinski-Harabasz c√†ng cao ch·ª©ng t·ªè c·ª•m n·ªôi t·∫°i c√†ng ch·∫∑t ch·∫Ω v√† c·ª•m v·ªõi c·ª•m c√†ng c√°ch bi·ªát. Trong tr∆∞·ªùng h·ª£p n√†y, ch·ªâ s·ªë ƒë·∫°t m·ª©c kh√° cao cho th·∫•y s·ª± t√°ch bi·ªát t·ªïng th·ªÉ gi·ªØa c√°c c·ª•m l√† t∆∞∆°ng ƒë·ªëi ·ªïn, m·∫∑c d√π kh√¥ng ph·∫£n √°nh r√µ c√°c ƒëi·ªÉm nhi·ªÖu ho·∫∑c g√°n sai c·ª•m nh∆∞ Silhouette Score.

## Tr·ª±c quan h√≥a k·∫øt qu·∫£ ph√¢n c·ª•m DBSCAN

UMAP (Uniform Manifold Approximation and Projection) l√† m·ªôt ph∆∞∆°ng ph√°p gi·∫£m chi·ªÅu d·ªØ li·ªáu r·∫•t hi·ªáu qu·∫£, ƒë·∫∑c bi·ªát khi tr·ª±c quan h√≥a c√°c k·∫øt qu·∫£ ph√¢n c·ª•m trong kh√¥ng gian 2D. Khi √°p d·ª•ng v√†o k·∫øt qu·∫£ ph√¢n c·ª•m DBSCAN, UMAP gi√∫p l√†m r√µ c·∫•u tr√∫c v√† m·ªëi quan h·ªá gi·ªØa c√°c ƒëi·ªÉm d·ªØ li·ªáu m√† c√°c ph∆∞∆°ng ph√°p gi·∫£m chi·ªÅu kh√°c c√≥ th·ªÉ kh√¥ng ph√°t hi·ªán ra. DBSCAN, v·ªën l√† ph∆∞∆°ng ph√°p ph√¢n c·ª•m kh√¥ng c√≥ s·∫µn s·ªë l∆∞·ª£ng c·ª•m tr∆∞·ªõc, c√≥ th·ªÉ t·∫°o ra c√°c c·ª•m v·ªõi h√¨nh d·∫°ng ph·ª©c t·∫°p v√† c√≥ th·ªÉ c√≥ m·ªôt s·ªë ƒëi·ªÉm nhi·ªÖu (noise). V·∫≠y n√™n nh√≥m s·ª≠ d·ª•ng UMAP trong tr∆∞·ªùng h·ª£p n√†y gi√∫p chuy·ªÉn c√°c ƒë·∫∑c t√≠nh kh√¥ng gian cao chi·ªÅu c·ªßa d·ªØ li·ªáu v√†o kh√¥ng gian 2D m·ªôt c√°ch tr·ª±c quan, gi·ªØ ƒë∆∞·ª£c c√°c c·∫•u tr√∫c c·∫≠n k·ªÅ v√† ph√¢n t√°ch r√µ r√†ng gi·ªØa c√°c c·ª•m.

```{r message=FALSE, warning=FALSE}
library(umap)
# Gi·∫£m chi·ªÅu b·∫±ng UMAP
set.seed(42)  # Gi·ªØ k·∫øt qu·∫£ ·ªïn ƒë·ªãnh
umap_result <- umap(scaled_data_DB)

# T·∫°o dataframe 2D t·ª´ k·∫øt qu·∫£ UMAP
umap_df <- as.data.frame(umap_result$layout)
colnames(umap_df) <- c("UMAP1", "UMAP2")

# G√°n nh√£n c·ª•m t·ª´ DBSCAN (n·∫øu c√≥)
umap_df$cluster <- factor(db_result$cluster)  # B·∫°n ƒë√£ ch·∫°y db_result ·ªü b∆∞·ªõc tr∆∞·ªõc r·ªìi

# V·∫Ω bi·ªÉu ƒë·ªì tr·ª±c quan c·ª•m
ggplot(umap_df, aes(x = UMAP1, y = UMAP2, color = cluster)) +
  geom_point(alpha = 0.7, size = 2) +
  labs(title = "Tr·ª±c quan h√≥a ph√¢n c·ª•m DBSCAN b·∫±ng UMAP",
       x = "UMAP1", y = "UMAP2") +
  scale_color_brewer(palette = "Set1") +
  theme_minimal()
```
**Nh·∫≠n x√©t:**

C√°c c·ª•m c√≥ h√¨nh d·∫°ng t·ª± nhi√™n, k√≠ch th∆∞·ªõc kh√°c nhau ‚Äì ƒë√∫ng v·ªõi ƒë·∫∑c ƒëi·ªÉm m√† DBSCAN ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ x·ª≠ l√Ω.

Ph·∫ßn l·ªõn c·ª•m t√°ch bi·ªát r√µ r√†ng, ƒë·∫∑c bi·ªát l√† c√°c c·ª•m l·ªõn nh∆∞ c·ª•m 2, 5, 6 v√† 11 cho th·∫•y:

DBSCAN ƒë√£ th√†nh c√¥ng trong vi·ªác nh·∫≠n di·ªán c√°c khu v·ª±c c√≥ m·∫≠t ƒë·ªô cao r√µ r√†ng trong kh√¥ng gian ƒë√£ ƒë∆∞·ª£c UMAP chi·∫øu xu·ªëng.

C·ª•m nhi·ªÖu (cluster 0) bao g·ªìm c√°c ƒëi·ªÉm r·∫£i r√°c: cho th·∫•y DBSCAN kh√¥ng √©p bu·ªôc c√°c ƒëi·ªÉm ngo·∫°i lai v√†o c·ª•m n√†o c·∫£.






